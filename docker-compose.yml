version: '3.8'

services:
  rag-system:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: offline-rag-system
    
    # Network isolation
    network_mode: none  # No network access
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G
        reservations:
          cpus: '4'
          memory: 8G
    
    # Volumes for persistence
    volumes:
      - ./data:/var/lib/rag-system:rw
      - ./logs:/var/log/rag-system:rw
      - ./models:/opt/models:ro
    
    # Environment variables
    environment:
      - TRANSFORMERS_OFFLINE=1
      - HF_DATASETS_OFFLINE=1
      - DISABLE_NETWORK=true
      - LOG_LEVEL=INFO
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (except mounted volumes)
    read_only: true
    
    tmpfs:
      - /tmp:mode=1777,size=2G
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
